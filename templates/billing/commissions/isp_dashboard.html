<!-- templates/billing/commissions/isp_dashboard.html -->
{% extends 'accounts/isp_base.html' %}
{% load static %}

{% block title %}Commission Dashboard - {{ tenant.name }}{% endblock %}

{% block page_title %}Commission Dashboard{% endblock %}
{% block page_subtitle %}Track platform commissions and net earnings{% endblock %}

{% block content %}
<div class="mb-8">
    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl p-6 shadow-lg">
            <div class="flex items-center">
                <div class="w-12 h-12 bg-white/20 rounded-lg flex items-center justify-center mr-4">
                    <i class="fas fa-money-bill-wave text-xl"></i>
                </div>
                <div>
                    <p class="text-sm opacity-90">Total Transactions</p>
                    <p class="text-2xl font-bold">KSh {{ summary.total_transactions|floatformat:0 }}</p>
                </div>
            </div>
        </div>
        
        <div class="bg-gradient-to-r from-red-500 to-red-600 text-white rounded-xl p-6 shadow-lg">
            <div class="flex items-center">
                <div class="w-12 h-12 bg-white/20 rounded-lg flex items-center justify-center mr-4">
                    <i class="fas fa-percentage text-xl"></i>
                </div>
                <div>
                    <p class="text-sm opacity-90">Total Commission</p>
                    <p class="text-2xl font-bold">KSh {{ summary.total_commission|floatformat:0 }}</p>
                </div>
            </div>
        </div>
        
        <div class="bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl p-6 shadow-lg">
            <div class="flex items-center">
                <div class="w-12 h-12 bg-white/20 rounded-lg flex items-center justify-center mr-4">
                    <i class="fas fa-chart-line text-xl"></i>
                </div>
                <div>
                    <p class="text-sm opacity-90">Net Earnings</p>
                    <p class="text-2xl font-bold">KSh {{ summary.total_net|floatformat:0 }}</p>
                </div>
            </div>
        </div>
        
        <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-xl p-6 shadow-lg">
            <div class="flex items-center">
                <div class="w-12 h-12 bg-white/20 rounded-lg flex items-center justify-center mr-4">
                    <i class="fas fa-calculator text-xl"></i>
                </div>
                <div>
                    <p class="text-sm opacity-90">Avg Commission Rate</p>
                    <p class="text-2xl font-bold">{{ summary.commission_percentage|floatformat:2 }}%</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Commission Transactions -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-8">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-lg font-medium text-gray-900">
                <i class="fas fa-history mr-2"></i>Recent Commission Transactions
            </h3>
            <span class="text-sm text-gray-500">{{ summary.transaction_count }} total transactions</span>
        </div>
        
        {% if recent_transactions %}
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead>
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Reference</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Service</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Amount</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Commission</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Net</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for transaction in recent_transactions %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                            {{ transaction.created_at|date:"M d, Y" }}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">
                            {{ transaction.payment.reference|truncatechars:10 }}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                            {% if transaction.commission %}
                                {{ transaction.commission.get_service_type_display }}
                            {% else %}
                                Bulk Data
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                            KSh {{ transaction.transaction_amount|floatformat:0 }}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-red-600 font-medium">
                            - KSh {{ transaction.commission_amount|floatformat:0 }}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-green-600 font-medium">
                            KSh {{ transaction.net_amount|floatformat:0 }}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs font-medium rounded-full 
                                {% if transaction.status == 'calculated' %}bg-green-100 text-green-800
                                {% elif transaction.status == 'pending' %}bg-yellow-100 text-yellow-800
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ transaction.get_status_display }}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        {% if summary.transaction_count > 10 %}
        <div class="mt-6 text-center">
            <a href="#" class="px-4 py-2 text-sm text-blue-600 hover:text-blue-800 font-medium">
                View All Transactions â†’
            </a>
        </div>
        {% endif %}
        
        {% else %}
        <div class="text-center py-12">
            <i class="fas fa-chart-pie text-4xl text-gray-300 mb-4"></i>
            <p class="text-gray-500">No commission transactions yet</p>
            <p class="text-sm text-gray-400 mt-1">Commission transactions will appear here after purchases</p>
        </div>
        {% endif %}
    </div>

    <!-- Commission Breakdown -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <!-- Commission Chart (Placeholder) -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">
                <i class="fas fa-chart-bar mr-2"></i>Commission Breakdown
            </h3>
            
            <div class="h-64 flex items-center justify-center">
                <div class="text-center">
                    <i class="fas fa-chart-pie text-4xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500">Commission chart will be displayed here</p>
                    <p class="text-sm text-gray-400">Showing commission distribution by service type</p>
                </div>
            </div>
        </div>
        
        <!-- Commission Information -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">
                <i class="fas fa-info-circle mr-2"></i>Commission Information
            </h3>
            
            <div class="space-y-4">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h4 class="font-medium text-blue-900 mb-2">How Commission Works</h4>
                    <p class="text-sm text-blue-700">
                        For every transaction, a platform commission is deducted before funds are allocated 
                        to your account. This commission covers platform maintenance, payment processing, 
                        and support services.
                    </p>
                </div>
                
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <h4 class="font-medium text-green-900 mb-2">Net Earnings</h4>
                    <p class="text-sm text-green-700">
                        Net earnings are the amount remaining after commission deduction. This amount 
                        is used for data distribution to your customers or can be settled to your 
                        bank account based on your settlement preferences.
                    </p>
                </div>
                
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <h4 class="font-medium text-yellow-900 mb-2">Commission Rates</h4>
                    <div class="space-y-2 text-sm text-yellow-700">
                        <div class="flex justify-between">
                            <span>Bulk Data Purchases:</span>
                            <span class="font-medium">7.5%</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Subscription Sales:</span>
                            <span class="font-medium">10%</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Data Top-ups:</span>
                            <span class="font-medium">5%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settlement Information -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">
            <i class="fas fa-wallet mr-2"></i>Settlement Information
        </h3>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="text-center p-4 bg-gray-50 rounded-lg">
                <div class="text-2xl font-bold text-gray-900 mb-1">KSh {{ summary.total_net|floatformat:0 }}</div>
                <p class="text-sm text-gray-500">Total Available for Settlement</p>
            </div>
            
            <div class="text-center p-4 bg-gray-50 rounded-lg">
                <div class="text-2xl font-bold text-gray-900 mb-1">30 days</div>
                <p class="text-sm text-gray-500">Settlement Cycle</p>
            </div>
            
            <div class="text-center p-4 bg-gray-50 rounded-lg">
                <div class="text-2xl font-bold text-gray-900 mb-1">PayStack</div>
                <p class="text-sm text-gray-500">Default Settlement Method</p>
            </div>
        </div>
        
        <div class="mt-6">
            <button onclick="requestSettlement()" 
                    class="px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-medium rounded-lg shadow-sm transition-all duration-200">
                <i class="fas fa-money-check-alt mr-2"></i>
                Request Settlement
            </button>
            <p class="mt-2 text-sm text-gray-500">
                Settlement requests are processed on the 1st of every month
            </p>
        </div>
    </div>
</div>

<script>
function requestSettlement() {
    if (confirm('Request settlement of your net earnings? This will initiate the settlement process.')) {
        // Implement settlement request
        alert('Settlement request would be submitted here.');
    }
}
</script>
{% endblock %}