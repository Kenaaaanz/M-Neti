<!-- templates/accounts/customer_map.html -->
{% extends 'base.html' %}
{% load static %}

{% block title %}My Location - M-Neti{% endblock %}

{% block extrastyle %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<style>
    /* Map Container */
    .map-container {
        position: relative;
        width: 100%;
        height: 500px;
        border-radius: 10px;
        overflow: hidden;
        background: #f8fafc;
    }
    
    /* Fix Leaflet issues */
    .leaflet-container {
        width: 100% !important;
        height: 100% !important;
        font: inherit !important;
    }
    
    /* Location button */
    .location-access-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
    }
    
    .location-access-btn:hover {
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }
    
    /* Input styling */
    .coordinate-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin: 1rem 0;
    }
    
    .input-group {
        display: flex;
        flex-direction: column;
    }
    
    .input-group label {
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 5px;
        color: #374151;
    }
    
    .input-group input,
    .input-group textarea {
        padding: 10px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 14px;
        resize: vertical;
    }
    
    .input-group input:focus,
    .input-group textarea:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    /* Button styling */
    .action-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 1rem;
    }
    
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 10px 20px;
        border-radius: 6px;
        font-weight: 500;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        outline: none;
        gap: 8px;
    }
    
    .btn-primary {
        background-color: #3b82f6;
        color: white;
    }
    
    .btn-primary:hover {
        background-color: #2563eb;
    }
    
    .btn-success {
        background-color: #10b981;
        color: white;
    }
    
    .btn-success:hover {
        background-color: #059669;
    }
    
    .btn-secondary {
        background-color: #6b7280;
        color: white;
    }
    
    .btn-secondary:hover {
        background-color: #4b5563;
    }
    
    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    /* Search box */
    .search-container {
        position: relative;
        margin-bottom: 1rem;
    }
    
    .search-input {
        width: 100%;
        padding: 12px 45px 12px 15px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 14px;
    }
    
    .search-button {
        position: absolute;
        right: 5px;
        top: 5px;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 8px 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    /* Search Results */
    .search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        margin-top: 5px;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        display: none;
    }
    
    .search-results.visible {
        display: block;
    }
    
    .search-result-item {
        padding: 12px 15px;
        border-bottom: 1px solid #f3f4f6;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .search-result-item:hover {
        background-color: #f9fafb;
    }
    
    .search-result-item:last-child {
        border-bottom: none;
    }
    
    .search-result-name {
        font-weight: 500;
        color: #111827;
        margin-bottom: 4px;
    }
    
    .search-result-details {
        font-size: 12px;
        color: #6b7280;
    }
    
    /* Toast notifications */
    .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slideIn 0.3s ease-out;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .toast-success { background-color: #10b981; }
    .toast-error { background-color: #ef4444; }
    .toast-warning { background-color: #f59e0b; }
    .toast-info { background-color: #3b82f6; }
    
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    /* Card styling */
    .info-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
    }
    
    .benefits-card {
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        border: 1px solid #bfdbfe;
        border-radius: 12px;
        padding: 20px;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .map-container {
            height: 400px;
        }
        
        .coordinate-grid {
            grid-template-columns: 1fr;
        }
        
        .action-buttons {
            flex-direction: column;
        }
        
        .btn {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-6">
    <!-- Header with Button -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">My Location</h1>
            <p class="text-gray-600 mt-1">Set your location for better service delivery and support</p>
        </div>
        
        <!-- Button to Access This Page from Other Pages -->
        <a href="{% url 'customer_map' %}" class="location-access-btn">
            <i class="fas fa-map-marker-alt"></i>
            <span>Set My Location</span>
        </a>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Map Column -->
        <div class="lg:col-span-2">
            <div class="info-card">
                <!-- Instructions -->
                <div class="mb-4">
                    <h3 class="text-lg font-semibold">Set Your Location</h3>
                    <p class="text-sm text-gray-500">Click on the map or search for your address</p>
                </div>
                
                <!-- Search Bar -->
                <div class="search-container">
                    <input type="text" 
                           id="addressSearch" 
                           class="search-input"
                           placeholder="Search for your address in Kenya...">
                    <button id="searchButton" class="search-button">
                        <i class="fas fa-search"></i>
                    </button>
                    <div id="searchResults" class="search-results"></div>
                </div>
                
                <!-- Map Container -->
                <div class="map-container">
                    <div id="map"></div>
                </div>
                
                <!-- Coordinates -->
                <div class="coordinate-grid">
                    <div class="input-group">
                        <label for="latitude">Latitude</label>
                        <input type="number" 
                               id="latitude" 
                               step="0.000001"
                               placeholder="-1.292000">
                    </div>
                    <div class="input-group">
                        <label for="longitude">Longitude</label>
                        <input type="number" 
                               id="longitude" 
                               step="0.000001"
                               placeholder="36.821900">
                    </div>
                </div>
                
                <!-- Address Display -->
                <div class="input-group">
                    <label for="addressDisplay">Address</label>
                    <textarea id="addressDisplay" 
                              rows="2"
                              placeholder="Address will appear here after selecting a location..."></textarea>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button id="saveLocation" class="btn btn-primary">
                        <i class="fas fa-save"></i>Save Location
                    </button>
                    <button id="useCurrentLocation" class="btn btn-success">
                        <i class="fas fa-location-crosshairs"></i>Use Current Location
                    </button>
                    <button id="clearLocation" class="btn btn-secondary">
                        <i class="fas fa-trash"></i>Clear
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Sidebar Column -->
        <div class="space-y-6">
            <!-- Location Info Card -->
            <div class="info-card">
                <h3 class="text-lg font-semibold mb-3">Location Information</h3>
                
                {% if primary_location %}
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Status:</span>
                        <span class="px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-800">
                            <i class="fas fa-check-circle mr-1"></i>Saved
                        </span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Address:</span>
                        <span class="text-right text-sm">{{ primary_location.address|truncatechars:30 }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Coordinates:</span>
                        <span class="text-sm">{{ primary_location.latitude|floatformat:6 }}, {{ primary_location.longitude|floatformat:6 }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Set on:</span>
                        <span class="text-sm">{{ primary_location.created_at|date:"M d, Y" }}</span>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-6 text-gray-500">
                    <i class="fas fa-map-marker-alt text-3xl mb-2"></i>
                    <p>No location set yet</p>
                    <p class="text-sm mt-2">Click on the map to set your location</p>
                </div>
                {% endif %}
            </div>

            <!-- Benefits Card -->
            <div class="benefits-card">
                <h3 class="text-lg font-semibold mb-3 text-blue-800">Why Set Your Location?</h3>
                <ul class="space-y-2 text-sm text-blue-700">
                    <li class="flex items-start">
                        <i class="fas fa-check-circle text-blue-500 mt-1 mr-2"></i>
                        <span>Faster service installation</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check-circle text-blue-500 mt-1 mr-2"></i>
                        <span>Accurate service coverage information</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check-circle text-blue-500 mt-1 mr-2"></i>
                        <span>Quick technician dispatch</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check-circle text-blue-500 mt-1 mr-2"></i>
                        <span>Network optimization</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check-circle text-blue-500 mt-1 mr-2"></i>
                        <span>Better troubleshooting support</span>
                    </li>
                </ul>
            </div>

            <!-- Quick Actions Card -->
            <div class="info-card">
                <h3 class="text-lg font-semibold mb-3">Quick Actions</h3>
                <div class="space-y-3">
                    <button id="quickCurrentLocation" class="w-full flex items-center justify-between p-3 rounded-lg border border-gray-200 hover:bg-gray-50 transition duration-200">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-location-crosshairs text-green-600"></i>
                            </div>
                            <div class="text-left">
                                <p class="font-medium">Use My Current Location</p>
                                <p class="text-xs text-gray-500">Detect automatically</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </button>
                    
                    <button id="quickSearch" class="w-full flex items-center justify-between p-3 rounded-lg border border-gray-200 hover:bg-gray-50 transition duration-200">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-search text-blue-600"></i>
                            </div>
                            <div class="text-left">
                                <p class="font-medium">Search Address</p>
                                <p class="text-xs text-gray-500">Find by street name</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </button>
                    
                    <a href="{% url 'support_chat' %}" class="block w-full flex items-center justify-between p-3 rounded-lg border border-gray-200 hover:bg-gray-50 transition duration-200">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-headset text-purple-600"></i>
                            </div>
                            <div class="text-left">
                                <p class="font-medium">Need Help?</p>
                                <p class="text-xs text-gray-500">Contact support</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ============================================================================
// CUSTOMER LOCATION MAP - WORKING VERSION
// ============================================================================

let map = null;
let marker = null;
let currentLatLng = null;

// Default Kenya bounds
const KENYA_BOUNDS = {
    southWest: [-5.0, 33.5],
    northEast: [5.0, 42.0]
};

const DEFAULT_LOCATION = {
    lat: -1.2921,
    lng: 36.8219,
    zoom: 7
};

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('ðŸš€ Initializing Customer Location Map...');
    
    try {
        initMap();
        setupEventListeners();
        setupDefaultLocation();
        console.log('âœ… Map initialized successfully');
    } catch (error) {
        console.error('âŒ Map initialization failed:', error);
        showToast('Failed to load map. Please refresh the page.', 'error');
    }
});

function initMap() {
    console.log('ðŸ—ºï¸ Creating map...');
    
    // Determine initial center
    let center;
    {% if primary_location %}
    center = { 
        lat: {{ primary_location.latitude }}, 
        lng: {{ primary_location.longitude }}, 
        zoom: 15 
    };
    {% else %}
    center = DEFAULT_LOCATION;
    {% endif %}
    
    // Create map
    map = L.map('map', {
        center: [center.lat, center.lng],
        zoom: center.zoom,
        zoomControl: true,
        dragging: true,
        touchZoom: true,
        scrollWheelZoom: true,
        doubleClickZoom: true,
        boxZoom: true,
        keyboard: true,
        maxBounds: [
            [KENYA_BOUNDS.southWest[0], KENYA_BOUNDS.southWest[1]],
            [KENYA_BOUNDS.northEast[0], KENYA_BOUNDS.northEast[1]]
        ],
        maxBoundsViscosity: 1.0
    });
    
    // Add tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        maxZoom: 19,
        minZoom: 6
    }).addTo(map);
    
    // Fix map size
    setTimeout(() => {
        if (map) {
            map.invalidateSize(true);
        }
    }, 100);
}

function setupDefaultLocation() {
    {% if primary_location %}
    // Use saved location
    currentLatLng = [{{ primary_location.latitude }}, {{ primary_location.longitude }}];
    marker = L.marker(currentLatLng, {
        draggable: true,
        title: 'Your Location'
    }).addTo(map);
    
    marker.bindPopup('{{ primary_location.address|escapejs }}').openPopup();
    
    updateFormFields(
        currentLatLng[0], 
        currentLatLng[1], 
        '{{ primary_location.address|escapejs }}'
    );
    
    // Add drag event
    marker.on('dragend', function(e) {
        const pos = marker.getLatLng();
        updateFormFields(pos.lat, pos.lng);
        reverseGeocode(pos.lat, pos.lng);
    });
    {% else %}
    // Set default Nairobi location
    updateLocation(DEFAULT_LOCATION.lat, DEFAULT_LOCATION.lng, "Nairobi, Kenya");
    {% endif %}
}

function updateLocation(lat, lng, address = '') {
    if (!map) return;
    
    // Validate Kenya bounds
    if (!isInKenya(lat, lng)) {
        showToast('Location must be within Kenya', 'warning');
        return;
    }
    
    // Remove existing marker
    if (marker) {
        map.removeLayer(marker);
        marker = null;
    }
    
    // Create new marker
    marker = L.marker([lat, lng], {
        draggable: true,
        title: 'Selected Location'
    }).addTo(map);
    
    // Center map
    map.setView([lat, lng], 15);
    
    // Update form
    updateFormFields(lat, lng, address);
    
    // Store location
    currentLatLng = [lat, lng];
    
    // Add drag event
    marker.on('dragend', function(e) {
        const pos = marker.getLatLng();
        updateFormFields(pos.lat, pos.lng);
        reverseGeocode(pos.lat, pos.lng);
    });
    
    // Bind popup
    if (address) {
        marker.bindPopup(address).openPopup();
    }
}

function updateFormFields(lat, lng, address = '') {
    document.getElementById('latitude').value = lat.toFixed(6);
    document.getElementById('longitude').value = lng.toFixed(6);
    document.getElementById('addressDisplay').value = address;
}

function isInKenya(lat, lng) {
    return (
        lat >= KENYA_BOUNDS.southWest[0] &&
        lat <= KENYA_BOUNDS.northEast[0] &&
        lng >= KENYA_BOUNDS.southWest[1] &&
        lng <= KENYA_BOUNDS.northEast[1]
    );
}

// Search Address Function
async function searchAddress() {
    const searchInput = document.getElementById('addressSearch');
    const resultsDiv = document.getElementById('searchResults');
    
    if (!searchInput || !resultsDiv) {
        console.error('Search elements not found');
        return;
    }
    
    const query = searchInput.value.trim();
    
    if (!query) {
        showToast('Please enter a location to search', 'warning');
        return;
    }
    
    // Show loading
    resultsDiv.innerHTML = '<div class="p-4 text-center text-gray-500">Searching...</div>';
    resultsDiv.classList.add('visible');
    
    try {
        // Use your Django endpoint
        const response = await fetch(`/accounts/api/search-address/?q=${encodeURIComponent(query)}&limit=5&countrycodes=ke`);
        
        if (!response.ok) {
            throw new Error(`HTTP error: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.error) {
            resultsDiv.innerHTML = `<div class="p-3 text-red-500">${data.error}</div>`;
            return;
        }
        
        if (!data.results || data.results.length === 0) {
            resultsDiv.innerHTML = '<div class="p-3 text-gray-500">No results found</div>';
            return;
        }
        
        // Display results
        let html = '';
        data.results.forEach((result, index) => {
            const safeName = result.display_name
                .replace(/"/g, '&quot;')
                .replace(/'/g, "&#39;");
            
            html += `
                <div class="search-result-item" onclick="selectSearchResult(${result.lat}, ${result.lon}, '${safeName}')">
                    <div class="search-result-name">${result.display_name}</div>
                    <div class="search-result-details">
                        ${result.type} â€¢ ${result.lat}, ${result.lon}
                    </div>
                </div>
            `;
        });
        
        resultsDiv.innerHTML = html;
        
    } catch (error) {
        console.error('Search failed:', error);
        resultsDiv.innerHTML = `<div class="p-3 text-red-500">Search failed: ${error.message}</div>`;
    }
}

function selectSearchResult(lat, lng, address) {
    updateLocation(lat, lng, address);
    hideSearchResults();
    showToast('Location selected', 'success');
}

function hideSearchResults() {
    const resultsDiv = document.getElementById('searchResults');
    if (resultsDiv) {
        resultsDiv.classList.remove('visible');
        resultsDiv.innerHTML = '';
    }
}

async function reverseGeocode(lat, lng) {
    if (marker) {
        marker.bindPopup('<i class="fas fa-spinner fa-spin"></i> Loading address...').openPopup();
    }
    
    try {
        const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&countrycodes=ke`;
        const response = await fetch(url, {
            headers: {
                'User-Agent': 'M-Neti/1.0 (contact@mneti.com)'
            }
        });
        const data = await response.json();
        
        if (data.display_name) {
            const address = data.display_name;
            document.getElementById('addressDisplay').value = address;
            if (marker) {
                marker.bindPopup(address).openPopup();
            }
            return address;
        }
    } catch (error) {
        console.warn('Reverse geocode failed:', error);
        const fallback = `Location at ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        document.getElementById('addressDisplay').value = fallback;
        if (marker) {
            marker.bindPopup(fallback).openPopup();
        }
        return fallback;
    }
}

function useCurrentLocation() {
    if (!navigator.geolocation) {
        showToast('Geolocation not supported by your browser', 'error');
        return;
    }
    
    const button = document.getElementById('useCurrentLocation');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Detecting...';
    button.disabled = true;
    
    navigator.geolocation.getCurrentPosition(
        (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            if (isInKenya(lat, lng)) {
                updateLocation(lat, lng);
                reverseGeocode(lat, lng);
                showToast('Current location detected', 'success');
            } else {
                showToast('Location outside Kenya. Please select a location within Kenya.', 'warning');
            }
            
            button.innerHTML = originalText;
            button.disabled = false;
        },
        (error) => {
            let message = 'Unable to get your location';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = 'Location access denied. Please enable location permissions in your browser.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = 'Location information unavailable.';
                    break;
                case error.TIMEOUT:
                    message = 'Location request timed out.';
                    break;
            }
            showToast(message, 'error');
            button.innerHTML = originalText;
            button.disabled = false;
        },
        { 
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        }
    );
}

async function saveLocation() {
    const lat = parseFloat(document.getElementById('latitude').value);
    const lng = parseFloat(document.getElementById('longitude').value);
    const address = document.getElementById('addressDisplay').value.trim();
    
    if (!lat || !lng || isNaN(lat) || isNaN(lng)) {
        showToast('Please select a location first', 'warning');
        return;
    }
    
    if (!isInKenya(lat, lng)) {
        showToast('Location must be within Kenya', 'error');
        return;
    }
    
    const button = document.getElementById('saveLocation');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    button.disabled = true;
    
    try {
        const csrfToken = getCSRFToken();
        const response = await fetch('{% url "save_customer_location" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ 
                latitude: lat, 
                longitude: lng, 
                address: address 
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('Location saved successfully!', 'success');
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            throw new Error(data.error || 'Failed to save location');
        }
    } catch (error) {
        console.error('Save failed:', error);
        showToast(`Save failed: ${error.message}`, 'error');
    } finally {
        button.innerHTML = originalText;
        button.disabled = false;
    }
}

function clearLocation() {
    if (!confirm('Are you sure you want to clear the location?')) {
        return;
    }
    
    if (marker) {
        map.removeLayer(marker);
        marker = null;
    }
    
    document.getElementById('latitude').value = '';
    document.getElementById('longitude').value = '';
    document.getElementById('addressDisplay').value = '';
    document.getElementById('addressSearch').value = '';
    currentLatLng = null;
    hideSearchResults();
    
    map.setView([DEFAULT_LOCATION.lat, DEFAULT_LOCATION.lng], DEFAULT_LOCATION.zoom);
    showToast('Location cleared', 'info');
}

function setupEventListeners() {
    // Map click
    map.on('click', function(e) {
        updateLocation(e.latlng.lat, e.latlng.lng);
        reverseGeocode(e.latlng.lat, e.latlng.lng);
    });
    
    // Main buttons
    document.getElementById('saveLocation').addEventListener('click', saveLocation);
    document.getElementById('useCurrentLocation').addEventListener('click', useCurrentLocation);
    document.getElementById('clearLocation').addEventListener('click', clearLocation);
    document.getElementById('searchButton').addEventListener('click', searchAddress);
    
    // Quick action buttons
    document.getElementById('quickCurrentLocation').addEventListener('click', useCurrentLocation);
    document.getElementById('quickSearch').addEventListener('click', function() {
        document.getElementById('addressSearch').focus();
    });
    
    // Search input events
    const searchInput = document.getElementById('addressSearch');
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            searchAddress();
        }
    });
    
    // Hide search results when clicking outside
    document.addEventListener('click', function(e) {
        const searchResults = document.getElementById('searchResults');
        const searchContainer = document.querySelector('.search-container');
        
        if (searchResults && searchContainer && 
            !searchContainer.contains(e.target) && 
            e.target !== searchResults) {
            hideSearchResults();
        }
    });
    
    // Coordinate inputs
    document.getElementById('latitude').addEventListener('change', function() {
        const lat = parseFloat(this.value);
        const lng = parseFloat(document.getElementById('longitude').value);
        if (!isNaN(lat) && !isNaN(lng)) {
            updateLocation(lat, lng);
            reverseGeocode(lat, lng);
        }
    });
    
    document.getElementById('longitude').addEventListener('change', function() {
        const lat = parseFloat(document.getElementById('latitude').value);
        const lng = parseFloat(this.value);
        if (!isNaN(lat) && !isNaN(lng)) {
            updateLocation(lat, lng);
            reverseGeocode(lat, lng);
        }
    });
    
    // Window resize
    window.addEventListener('resize', function() {
        setTimeout(() => {
            if (map) map.invalidateSize(true);
        }, 250);
    });
}

function getCSRFToken() {
    const cookieValue = document.cookie
        .split('; ')
        .find(row => row.startsWith('csrftoken='))
        ?.split('=')[1];
    
    if (!cookieValue) {
        const metaTag = document.querySelector('meta[name="csrf-token"]');
        return metaTag ? metaTag.getAttribute('content') : '';
    }
    
    return cookieValue;
}

function showToast(message, type = 'info') {
    // Remove existing toast
    const existingToast = document.querySelector('.toast');
    if (existingToast) {
        existingToast.remove();
    }
    
    // Create new toast
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    
    const icons = {
        success: 'fa-check-circle',
        error: 'fa-exclamation-circle',
        warning: 'fa-exclamation-triangle',
        info: 'fa-info-circle'
    };
    
    toast.innerHTML = `
        <i class="fas ${icons[type] || 'fa-info-circle'}"></i>
        <span>${message}</span>
    `;
    
    document.body.appendChild(toast);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// Make functions available globally
window.searchAddress = searchAddress;
window.selectSearchResult = selectSearchResult;
window.useCurrentLocation = useCurrentLocation;
</script>
{% endblock %}