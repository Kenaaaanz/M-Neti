{% extends 'base.html' %}
{% load static %}

{% block body_class %}map-page{% endblock %}

{% block title %}My Location - M-Neti{% endblock %}

{% block extrastyle %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />

<style>
    /* RESET: Force proper map styling */
    #map {
        width: 100% !important;
        height: 100% !important;
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        z-index: 1 !important;
    }
    
    .map-container {
        position: relative !important;
        width: 100% !important;
        height: 500px !important;
        border-radius: 10px !important;
        overflow: hidden !important;
        background: #f8fafc !important;
        margin-bottom: 1rem !important;
        border: 1px solid #e2e8f0 !important;
    }
    
    /* CRITICAL: Force Leaflet to work correctly */
    .leaflet-container {
        font: 12px/1.5 "Helvetica Neue", Arial, Helvetica, sans-serif !important;
    }
    
    .leaflet-container .leaflet-tile {
        margin: 0 !important;
        padding: 0 !important;
        border: none !important;
        background: none !important;
    }
    
    .leaflet-container img.leaflet-tile {
        width: 256px !important;
        height: 256px !important;
        image-rendering: -webkit-optimize-contrast;
        image-rendering: crisp-edges;
    }
    
    .leaflet-tile-container img {
        width: 256px !important;
        height: 256px !important;
    }
    
    /* Page specific styles */
    .location-access-btn {
        display: inline-flex !important;
        align-items: center !important;
        gap: 8px !important;
        padding: 10px 20px !important;
        background: linear-gradient(135deg, #3b82f6, #2563eb) !important;
        color: white !important;
        border: none !important;
        border-radius: 8px !important;
        font-weight: 500 !important;
        cursor: pointer !important;
        transition: all 0.2s !important;
        text-decoration: none !important;
    }
    
    .location-access-btn:hover {
        background: linear-gradient(135deg, #2563eb, #1d4ed8) !important;
        transform: translateY(-1px) !important;
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3) !important;
    }
    
    /* Input styling */
    .coordinate-grid {
        display: grid !important;
        grid-template-columns: 1fr 1fr !important;
        gap: 1rem !important;
        margin: 1rem 0 !important;
    }
    
    .input-group {
        display: flex !important;
        flex-direction: column !important;
    }
    
    .input-group label {
        font-size: 14px !important;
        font-weight: 500 !important;
        margin-bottom: 5px !important;
        color: #374151 !important;
    }
    
    .input-group input,
    .input-group textarea {
        padding: 10px !important;
        border: 1px solid #d1d5db !important;
        border-radius: 6px !important;
        font-size: 14px !important;
        resize: vertical !important;
        background: white !important;
        color: #1f2937 !important;
    }
    
    .input-group input:focus,
    .input-group textarea:focus {
        outline: none !important;
        border-color: #3b82f6 !important;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
    }
    
    /* Button styling */
    .action-buttons {
        display: flex !important;
        gap: 10px !important;
        flex-wrap: wrap !important;
        margin-top: 1rem !important;
    }
    
    .btn {
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
        padding: 10px 20px !important;
        border-radius: 6px !important;
        font-weight: 500 !important;
        font-size: 14px !important;
        cursor: pointer !important;
        transition: all 0.2s !important;
        border: none !important;
        outline: none !important;
        gap: 8px !important;
    }
    
    .btn-primary {
        background-color: #3b82f6 !important;
        color: white !important;
    }
    
    .btn-primary:hover {
        background-color: #2563eb !important;
    }
    
    .btn-success {
        background-color: #10b981 !important;
        color: white !important;
    }
    
    .btn-success:hover {
        background-color: #059669 !important;
    }
    
    .btn-secondary {
        background-color: #6b7280 !important;
        color: white !important;
    }
    
    .btn-secondary:hover {
        background-color: #4b5563 !important;
    }
    
    .btn:disabled {
        opacity: 0.6 !important;
        cursor: not-allowed !important;
    }
    
    /* Search box */
    .search-container {
        position: relative !important;
        margin-bottom: 1rem !important;
    }
    
    .search-input {
        width: 100% !important;
        padding: 12px 45px 12px 15px !important;
        border: 1px solid #d1d5db !important;
        border-radius: 6px !important;
        font-size: 14px !important;
        background: white !important;
    }
    
    .search-button {
        position: absolute !important;
        right: 5px !important;
        top: 5px !important;
        background: #3b82f6 !important;
        color: white !important;
        border: none !important;
        border-radius: 4px !important;
        padding: 8px 12px !important;
        cursor: pointer !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
    }
    
    /* Search Results */
    .search-results {
        position: absolute !important;
        top: 100% !important;
        left: 0 !important;
        right: 0 !important;
        background: white !important;
        border: 1px solid #e5e7eb !important;
        border-radius: 6px !important;
        margin-top: 5px !important;
        max-height: 300px !important;
        overflow-y: auto !important;
        z-index: 1000 !important;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1) !important;
        display: none !important;
    }
    
    .search-results.visible {
        display: block !important;
    }
    
    .search-result-item {
        padding: 12px 15px !important;
        border-bottom: 1px solid #f3f4f6 !important;
        cursor: pointer !important;
        transition: background-color 0.2s !important;
    }
    
    .search-result-item:hover {
        background-color: #f9fafb !important;
    }
    
    .search-result-item:last-child {
        border-bottom: none !important;
    }
    
    .search-result-name {
        font-weight: 500 !important;
        color: #111827 !important;
        margin-bottom: 4px !important;
    }
    
    .search-result-details {
        font-size: 12px !important;
        color: #6b7280 !important;
    }
    
    /* Toast notifications */
    .toast {
        position: fixed !important;
        top: 20px !important;
        right: 20px !important;
        padding: 12px 20px !important;
        border-radius: 8px !important;
        color: white !important;
        font-weight: 500 !important;
        z-index: 10000 !important;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
        animation: slideIn 0.3s ease-out !important;
        display: flex !important;
        align-items: center !important;
        gap: 10px !important;
    }
    
    .toast-success { background-color: #10b981 !important; }
    .toast-error { background-color: #ef4444 !important; }
    .toast-warning { background-color: #f59e0b !important; }
    .toast-info { background-color: #3b82f6 !important; }
    
    @keyframes slideIn {
        from {
            transform: translateX(100%) !important;
            opacity: 0 !important;
        }
        to {
            transform: translateX(0) !important;
            opacity: 1 !important;
        }
    }
    
    /* Card styling */
    .info-card {
        background: white !important;
        border-radius: 12px !important;
        padding: 20px !important;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) !important;
        border: 1px solid #e5e7eb !important;
    }
    
    .benefits-card {
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%) !important;
        border: 1px solid #bfdbfe !important;
        border-radius: 12px !important;
        padding: 20px !important;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .map-container {
            height: 400px !important;
        }
        
        .coordinate-grid {
            grid-template-columns: 1fr !important;
        }
        
        .action-buttons {
            flex-direction: column !important;
        }
        
        .btn {
            width: 100% !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-6">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">My Location</h1>
            <p class="text-gray-600 mt-1">Set your location for better service delivery and support</p>
        </div>
        
        <a href="{% url 'customer_map' %}" class="location-access-btn">
            <i class="fas fa-map-marker-alt"></i>
            <span>Set My Location</span>
        </a>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Map Column -->
        <div class="lg:col-span-2">
            <div class="info-card">
                <!-- Instructions -->
                <div class="mb-4">
                    <h3 class="text-lg font-semibold">Set Your Location</h3>
                    <p class="text-sm text-gray-500">Click on the map or search for your address</p>
                </div>
                
                <!-- Search Bar -->
                <div class="search-container">
                    <input type="text" 
                           id="addressSearch" 
                           class="search-input"
                           placeholder="Search for your address in Kenya...">
                    <button id="searchButton" class="search-button">
                        <i class="fas fa-search"></i>
                    </button>
                    <div id="searchResults" class="search-results"></div>
                </div>
                
                <!-- Map Container - SIMPLE STRUCTURE -->
                <div class="map-container" id="mapContainer">
                    <div id="map"></div>
                </div>
                
                <!-- Coordinates -->
                <div class="coordinate-grid">
                    <div class="input-group">
                        <label for="latitude">Latitude</label>
                        <input type="number" 
                               id="latitude" 
                               step="0.000001"
                               placeholder="-1.292000">
                    </div>
                    <div class="input-group">
                        <label for="longitude">Longitude</label>
                        <input type="number" 
                               id="longitude" 
                               step="0.000001"
                               placeholder="36.821900">
                    </div>
                </div>
                
                <!-- Address Display -->
                <div class="input-group">
                    <label for="addressDisplay">Address</label>
                    <textarea id="addressDisplay" 
                              rows="2"
                              placeholder="Address will appear here after selecting a location..."></textarea>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button id="saveLocation" class="btn btn-primary">
                        <i class="fas fa-save"></i>Save Location
                    </button>
                    <button id="useCurrentLocation" class="btn btn-success">
                        <i class="fas fa-location-crosshairs"></i>Use Current Location
                    </button>
                    <button id="clearLocation" class="btn btn-secondary">
                        <i class="fas fa-trash"></i>Clear
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Sidebar Column -->
        <div class="space-y-6">
            <!-- Location Info Card -->
            <div class="info-card">
                <h3 class="text-lg font-semibold mb-3">Location Information</h3>
                
                {% if primary_location %}
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Status:</span>
                        <span class="px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-800">
                            <i class="fas fa-check-circle mr-1"></i>Saved
                        </span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Address:</span>
                        <span class="text-right text-sm">{{ primary_location.address|truncatechars:30 }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Coordinates:</span>
                        <span class="text-sm">{{ primary_location.latitude|floatformat:6 }}, {{ primary_location.longitude|floatformat:6 }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Set on:</span>
                        <span class="text-sm">{{ primary_location.created_at|date:"M d, Y" }}</span>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-6 text-gray-500">
                    <i class="fas fa-map-marker-alt text-3xl mb-2"></i>
                    <p>No location set yet</p>
                    <p class="text-sm mt-2">Click on the map to set your location</p>
                </div>
                {% endif %}
            </div>

            <!-- Benefits Card -->
            <div class="benefits-card">
                <h3 class="text-lg font-semibold mb-3 text-blue-800">Why Set Your Location?</h3>
                <ul class="space-y-2 text-sm text-blue-700">
                    <li class="flex items-start">
                        <i class="fas fa-check-circle text-blue-500 mt-1 mr-2"></i>
                        <span>Faster service installation</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check-circle text-blue-500 mt-1 mr-2"></i>
                        <span>Accurate service coverage information</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check-circle text-blue-500 mt-1 mr-2"></i>
                        <span>Quick technician dispatch</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check-circle text-blue-500 mt-1 mr-2"></i>
                        <span>Network optimization</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check-circle text-blue-500 mt-1 mr-2"></i>
                        <span>Better troubleshooting support</span>
                    </li>
                </ul>
            </div>

            <!-- Quick Actions Card -->
            <div class="info-card">
                <h3 class="text-lg font-semibold mb-3">Quick Actions</h3>
                <div class="space-y-3">
                    <button id="quickCurrentLocation" class="w-full flex items-center justify-between p-3 rounded-lg border border-gray-200 hover:bg-gray-50 transition duration-200">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-location-crosshairs text-green-600"></i>
                            </div>
                            <div class="text-left">
                                <p class="font-medium">Use My Current Location</p>
                                <p class="text-xs text-gray-500">Detect automatically</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </button>
                    
                    <button id="quickSearch" class="w-full flex items-center justify-between p-3 rounded-lg border border-gray-200 hover:bg-gray-50 transition duration-200">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-search text-blue-600"></i>
                            </div>
                            <div class="text-left">
                                <p class="font-medium">Search Address</p>
                                <p class="text-xs text-gray-500">Find by street name</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </button>
                    
                    <a href="{% url 'support_chat' %}" class="block w-full flex items-center justify-between p-3 rounded-lg border border-gray-200 hover:bg-gray-50 transition duration-200">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-headset text-purple-600"></i>
                            </div>
                            <div class="text-left">
                                <p class="font-medium">Need Help?</p>
                                <p class="text-xs text-gray-500">Contact support</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

<script>
// ============================================================================
// CUSTOMER LOCATION MAP - FIXED VERSION
// ============================================================================

let map = null;
let marker = null;

// Default Nairobi location
const DEFAULT_LOCATION = {
    lat: -1.2921,
    lng: 36.8219,
    zoom: 12
};

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Initializing Customer Location Map...');
    
    // Delay initialization slightly to ensure DOM is fully ready
    setTimeout(() => {
        try {
            initMap();
            setupEventListeners();
            setupDefaultLocation();
            
            // CRITICAL: Force map to redraw after a short delay
            setTimeout(() => {
                if (map) {
                    map.invalidateSize();
                    console.log('‚úÖ Map invalidated size');
                    
                    // Force a tile refresh
                    map.setView(map.getCenter(), map.getZoom());
                }
            }, 200);
            
            console.log('‚úÖ Map initialized successfully');
        } catch (error) {
            console.error('‚ùå Map initialization failed:', error);
            showToast('Failed to load map. Please refresh the page.', 'error');
        }
    }, 100);
});

function initMap() {
    console.log('üó∫Ô∏è Creating map...');
    
    // Remove any existing map instance
    if (map) {
        map.remove();
        map = null;
    }
    
    // Clear the map container
    const mapElement = document.getElementById('map');
    if (mapElement) {
        mapElement.innerHTML = '';
    }
    
    // Determine initial center
    let center;
    {% if primary_location %}
    center = { 
        lat: {{ primary_location.latitude }}, 
        lng: {{ primary_location.longitude }}, 
        zoom: 15 
    };
    console.log('Using saved location:', center);
    {% else %}
    center = DEFAULT_LOCATION;
    console.log('Using default location:', center);
    {% endif %}
    
    // Create map with proper options
    map = L.map('map', {
        center: [center.lat, center.lng],
        zoom: center.zoom,
        zoomControl: true,
        dragging: true,
        touchZoom: true,
        scrollWheelZoom: true,
        doubleClickZoom: true,
        boxZoom: true,
        keyboard: true
    });
    
    console.log('Map created, adding tiles...');
    
    // Add tile layer with proper attribution
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19,
        minZoom: 6,
        subdomains: ['a', 'b', 'c'],
        tileSize: 256,
        zoomOffset: 0
    }).addTo(map);
    
    console.log('Tiles added, map should be visible');
    
    // Force immediate size check
    setTimeout(() => {
        if (map) {
            map.invalidateSize(true);
        }
    }, 50);
}

function setupDefaultLocation() {
    {% if primary_location %}
    // Use saved location
    const lat = {{ primary_location.latitude }};
    const lng = {{ primary_location.longitude }};
    const address = '{{ primary_location.address|escapejs }}';
    
    console.log('Setting up saved location:', lat, lng, address);
    updateLocation(lat, lng, address);
    {% else %}
    // Set default Nairobi location
    console.log('Setting up default location');
    updateLocation(DEFAULT_LOCATION.lat, DEFAULT_LOCATION.lng, "Nairobi, Kenya");
    {% endif %}
}

function updateLocation(lat, lng, address = '') {
    if (!map) {
        console.error('Map not initialized');
        return;
    }
    
    console.log('Updating location to:', lat, lng, address);
    
    // Remove existing marker
    if (marker) {
        map.removeLayer(marker);
        marker = null;
    }
    
    // Create new marker
    marker = L.marker([lat, lng], {
        draggable: true,
        title: 'Your Location'
    }).addTo(map);
    
    // Center map
    map.setView([lat, lng], 15);
    
    // Update form fields
    updateFormFields(lat, lng, address);
    
    // Add drag event
    marker.on('dragend', function(e) {
        const pos = marker.getLatLng();
        console.log('Marker dragged to:', pos.lat, pos.lng);
        updateFormFields(pos.lat, pos.lng);
        reverseGeocode(pos.lat, pos.lng);
    });
    
    // Bind popup
    if (address) {
        marker.bindPopup(address).openPopup();
    } else {
        reverseGeocode(lat, lng);
    }
    
    // Force map refresh
    setTimeout(() => {
        if (map) {
            map.invalidateSize();
        }
    }, 100);
}

function updateFormFields(lat, lng, address = '') {
    const latInput = document.getElementById('latitude');
    const lngInput = document.getElementById('longitude');
    const addressInput = document.getElementById('addressDisplay');
    
    if (latInput) latInput.value = lat.toFixed(6);
    if (lngInput) lngInput.value = lng.toFixed(6);
    if (addressInput) addressInput.value = address;
}

async function searchAddress() {
    const searchInput = document.getElementById('addressSearch');
    const resultsDiv = document.getElementById('searchResults');
    
    if (!searchInput || !resultsDiv) {
        console.error('Search elements not found');
        return;
    }
    
    const query = searchInput.value.trim();
    
    if (!query) {
        showToast('Please enter a location to search', 'warning');
        return;
    }
    
    // Show loading
    resultsDiv.innerHTML = '<div class="p-4 text-center text-gray-500">Searching...</div>';
    resultsDiv.classList.add('visible');
    
    try {
        // Use OpenStreetMap Nominatim API
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=ke&limit=5`;
        console.log('Searching:', url);
        
        const response = await fetch(url, {
            headers: {
                'User-Agent': 'M-Neti/1.0',
                'Accept': 'application/json'
            }
        });
        
        const data = await response.json();
        console.log('Search results:', data);
        
        if (data.length === 0) {
            resultsDiv.innerHTML = '<div class="p-3 text-gray-500">No results found</div>';
            return;
        }
        
        // Display results
        let html = '';
        data.forEach((result, index) => {
            const safeName = result.display_name
                .replace(/"/g, '&quot;')
                .replace(/'/g, "&#39;");
            
            html += `
                <div class="search-result-item" onclick="selectSearchResult(${result.lat}, ${result.lon}, '${safeName}')">
                    <div class="search-result-name">${result.display_name}</div>
                    <div class="search-result-details">
                        ${result.type} ‚Ä¢ ${parseFloat(result.lat).toFixed(6)}, ${parseFloat(result.lon).toFixed(6)}
                    </div>
                </div>
            `;
        });
        
        resultsDiv.innerHTML = html;
        
    } catch (error) {
        console.error('Search failed:', error);
        resultsDiv.innerHTML = '<div class="p-3 text-red-500">Search failed. Please try again.</div>';
    }
}

function selectSearchResult(lat, lng, address) {
    updateLocation(parseFloat(lat), parseFloat(lng), address);
    hideSearchResults();
    showToast('Location selected', 'success');
}

function hideSearchResults() {
    const resultsDiv = document.getElementById('searchResults');
    if (resultsDiv) {
        resultsDiv.classList.remove('visible');
        resultsDiv.innerHTML = '';
    }
}

async function reverseGeocode(lat, lng) {
    try {
        const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18`;
        const response = await fetch(url, {
            headers: {
                'User-Agent': 'M-Neti/1.0',
                'Accept': 'application/json'
            }
        });
        const data = await response.json();
        
        if (data.display_name) {
            const address = data.display_name;
            document.getElementById('addressDisplay').value = address;
            if (marker) {
                marker.bindPopup(address).openPopup();
            }
            return address;
        }
    } catch (error) {
        console.warn('Reverse geocode failed:', error);
        const fallback = `Location at ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        document.getElementById('addressDisplay').value = fallback;
        if (marker) {
            marker.bindPopup(fallback).openPopup();
        }
        return fallback;
    }
}

function useCurrentLocation() {
    if (!navigator.geolocation) {
        showToast('Geolocation not supported by your browser', 'error');
        return;
    }
    
    const button = document.getElementById('useCurrentLocation');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Detecting...';
    button.disabled = true;
    
    navigator.geolocation.getCurrentPosition(
        (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            console.log('Got current location:', lat, lng);
            updateLocation(lat, lng);
            reverseGeocode(lat, lng);
            showToast('Current location detected', 'success');
            
            button.innerHTML = originalText;
            button.disabled = false;
        },
        (error) => {
            console.error('Geolocation error:', error);
            let message = 'Unable to get your location';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = 'Location access denied. Please enable location permissions.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = 'Location information unavailable.';
                    break;
                case error.TIMEOUT:
                    message = 'Location request timed out.';
                    break;
            }
            showToast(message, 'error');
            button.innerHTML = originalText;
            button.disabled = false;
        },
        { 
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        }
    );
}

async function saveLocation() {
    const lat = parseFloat(document.getElementById('latitude').value);
    const lng = parseFloat(document.getElementById('longitude').value);
    const address = document.getElementById('addressDisplay').value.trim();
    
    if (!lat || !lng || isNaN(lat) || isNaN(lng)) {
        showToast('Please select a location first', 'warning');
        return;
    }
    
    const button = document.getElementById('saveLocation');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    button.disabled = true;
    
    try {
        const csrfToken = getCSRFToken();
        const response = await fetch('{% url "save_customer_location" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ 
                latitude: lat, 
                longitude: lng, 
                address: address 
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('Location saved successfully!', 'success');
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            throw new Error(data.error || 'Failed to save location');
        }
    } catch (error) {
        console.error('Save failed:', error);
        showToast(`Save failed: ${error.message}`, 'error');
    } finally {
        button.innerHTML = originalText;
        button.disabled = false;
    }
}

function clearLocation() {
    if (!confirm('Are you sure you want to clear the location?')) {
        return;
    }
    
    if (marker) {
        map.removeLayer(marker);
        marker = null;
    }
    
    document.getElementById('latitude').value = '';
    document.getElementById('longitude').value = '';
    document.getElementById('addressDisplay').value = '';
    document.getElementById('addressSearch').value = '';
    
    map.setView([DEFAULT_LOCATION.lat, DEFAULT_LOCATION.lng], DEFAULT_LOCATION.zoom);
    showToast('Location cleared', 'info');
}

function setupEventListeners() {
    // Map click
    map.on('click', function(e) {
        console.log('Map clicked at:', e.latlng.lat, e.latlng.lng);
        updateLocation(e.latlng.lat, e.latlng.lng);
        reverseGeocode(e.latlng.lat, e.latlng.lng);
    });
    
    // Main buttons
    document.getElementById('saveLocation').addEventListener('click', saveLocation);
    document.getElementById('useCurrentLocation').addEventListener('click', useCurrentLocation);
    document.getElementById('clearLocation').addEventListener('click', clearLocation);
    document.getElementById('searchButton').addEventListener('click', searchAddress);
    
    // Quick action buttons
    document.getElementById('quickCurrentLocation').addEventListener('click', useCurrentLocation);
    document.getElementById('quickSearch').addEventListener('click', function() {
        document.getElementById('addressSearch').focus();
    });
    
    // Search input events
    const searchInput = document.getElementById('addressSearch');
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            searchAddress();
        }
    });
    
    // Hide search results when clicking outside
    document.addEventListener('click', function(e) {
        const searchResults = document.getElementById('searchResults');
        const searchContainer = document.querySelector('.search-container');
        
        if (searchResults && searchContainer && 
            !searchContainer.contains(e.target) && 
            e.target !== searchResults) {
            hideSearchResults();
        }
    });
    
    // Coordinate inputs
    document.getElementById('latitude').addEventListener('change', function() {
        const lat = parseFloat(this.value);
        const lng = parseFloat(document.getElementById('longitude').value);
        if (!isNaN(lat) && !isNaN(lng)) {
            updateLocation(lat, lng);
            reverseGeocode(lat, lng);
        }
    });
    
    document.getElementById('longitude').addEventListener('change', function() {
        const lat = parseFloat(document.getElementById('latitude').value);
        const lng = parseFloat(this.value);
        if (!isNaN(lat) && !isNaN(lng)) {
            updateLocation(lat, lng);
            reverseGeocode(lat, lng);
        }
    });
    
    // Window resize - fix map size
    let resizeTimer;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(function() {
            if (map) {
                map.invalidateSize(true);
                console.log('Map resized');
            }
        }, 250);
    });
}

function getCSRFToken() {
    const cookieValue = document.cookie
        .split('; ')
        .find(row => row.startsWith('csrftoken='))
        ?.split('=')[1];
    
    if (!cookieValue) {
        const metaTag = document.querySelector('meta[name="csrf-token"]');
        return metaTag ? metaTag.getAttribute('content') : '';
    }
    
    return cookieValue;
}

function showToast(message, type = 'info') {
    // Remove existing toast
    const existingToast = document.querySelector('.toast');
    if (existingToast) {
        existingToast.remove();
    }
    
    // Create new toast
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    
    const icons = {
        success: 'fa-check-circle',
        error: 'fa-exclamation-circle',
        warning: 'fa-exclamation-triangle',
        info: 'fa-info-circle'
    };
    
    toast.innerHTML = `
        <i class="fas ${icons[type] || 'fa-info-circle'}"></i>
        <span>${message}</span>
    `;
    
    document.body.appendChild(toast);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// Make functions available globally
window.searchAddress = searchAddress;
window.selectSearchResult = selectSearchResult;
window.useCurrentLocation = useCurrentLocation;
</script>
{% endblock %}